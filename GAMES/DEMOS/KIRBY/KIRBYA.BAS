1      'save"kirby.bas
10 COLOR15,0,0:SCREEN5,2:DEFINTA-Z
20 SETPAGE0,3:BLOAD"kirbyt1.sc5",S:COLOR=RESTORE
30 G=6:S=13:SETPAGE0,0:FORI=0TO100:LINE(128-I,6+I)-(128-I,206-I),G:LINE(128+I,6+I)-(128+I,206-I),S:IFI>80THEN37
35 LINE(128-I,26+I)-(128-I,186-I),S:LINE(128+I,26+I)-(128+I,186-I),G
37 NEXT
40 FORI=0TO28STEP2:COPY(0,30-I)-(125,28-I),3TO(60,92-I),0,TPSET:COPY(0,28+I)-(125,30+I),3TO(60,90+I),0,TPSET:NEXT
45 COPY(28,130)-(228,138),0TO(0,200),3
50 FORI=0TO8:COPY(126,I)-(256,I),3TO(64,130+I),0,TPSET:NEXT:IFA=0THENBLOAD"kirbyspr.sp5",SELSE60
60 SETPAGE0,1:BLOAD"kirby.vpk",S
65 SETPAGE0,2:COPY(0,0)-(255,5),2TO(0,0),1
70 BLOAD"kirbyd.sc5",S:COLOR=RESTORE
75 COPY(0,200)-(200,208),3TO(28,130),0
80 SETPAGE0,0:FORI=11TO19:COPY(126,I)-(256,I),3TO(64,130+I-11),0,TPSET:NEXT
100 IFSTRIG(0)THENCLSELSE100
500 BEEP
1000 '
1010 CALLTURBOON
1020 DIMX(1),Y(1),G(2),C(3),D(1),J(1),A(1),B(1),T(1),S(1)
1030 COPY(0,59)-(255,89),3TO(0,0),0:GL=0:LM=50:GOSUB1520:ONSPRITEGOSUB1770
1040 SPRITEOFF:ZT=2:N=0:X=48:Y=64:Z=4:R=0:RR=1:SE=2
1050 SOUND8,0:SOUND9,0:SOUND10,0:GOSUB1840
1060 'GOSUB2020
1065 IFJY=0THENDY=2:GY=0ELSEIFJY<4ORJY>16THENDY=-1:JY=JY-1:GY=1ELSEDY=-2:JY=JY-1
1066 'DY=-2*(JY=0)-1*(JY<5ORJY>15)-2*(JY>4ANDJY<16):JY=JY+1*(JY>0)
1070 S=STICK(0):DX=2*(S>5)-2*(S>1ANDS<5):NX=X+DX:NY=Y+DY1250
1075 FORI=0TO1:JJ=1XORI:IFSTRIG(0)ANDT(I)=0ANDT(JJ)<6ANDS><5THENT(I)=16:Y(I)=Y:X(I)=X+8+16*(Z>16):S(I)=36-1*(Z>16)
1080 IFT(I)>0THENT(I)=T(I)-1:X(I)=X(I)+4+8*(S(I)=37)
1085 PUTSPRITE6+I,(X(I),Y(I)-1),9,S(I):IFT(I)=0ORX(I)>240ORX(I)<0THENS(I)=60
1089 NEXTI
1090 OUT&HAA,5:UU=INP(&HA9):IFUU=247ANDC(3)>0ANDLI<LMTHENI=3:C(I)=C(I)-1:GOSUB1500:LJ=LI:LJ=LJ+20:GOSUB1510
1100 VA=VPEEK(VN+INT((8+X+4*DX)/16)+INT((Y+2)/16)*16):VB=VPEEK(VN+INT((8+X+4*DX)/16)+INT((Y+14)/16)*16)
1102 IFVA<64ANDVB<64THENX=X+DX:ELSEVA=0:VB=0:DX=0
1105 VC=VPEEK(VN+INT((4+X-DX*(DX=-2))/16)+INT((8+Y+4*DY)/16)*16):VD=VPEEK(VN+INT((11+X+DX*(DX=2))/16)+INT((8+Y+4*DY)/16)*16)
1110 'IFS=1ANDVA>150ANDVB>150THENTA=1:VT=VA:TY=NY
1120 IFVC<64ANDVD<64THENY=Y+DY:ELSEVC=0:VD=0:IFDY=2ANDJY=0THENDY=0:IFS=1ORS=2ORS=8THENJY=22
1130 IF(VA>31ORVB>31ORVC>31ORVC>31)ANDTA=0THENTA=2
1140 IFLI=0THEN1810
1150 IFINKEY$="q"THEN2080
1160 IFZS>0THENZS=ZS-1:ZT=ZSMOD2+2:MB=ZT-2:MA=200+ZS:GOSUB2010:GOTO1190ELSESPRITEON
1170 'IFG=-1ANDEP>0ANDEG=0THEN1230
1180 SOUND8,0
1190 ZZ=-ZZ*(S=0ORS=1ORS=5)-18*(S>5):Z=ZZ-3*(JY>0ORDY=2ORGY=1)-(INT((XMOD24)/8))*(DY=0ANDS>0ANDS><5)-5*(S=5ANDDY=0):GOSUB1450:PN=-1*(X=240)-2*(X=0)-3*(Y>192)-4*(Y<32):ONPNGOTO1300,1310,1320,1330
1195 'GOSUB1450:PN=-1*(X=240)-2*(X=0)-3*(Y=192)-4*(Y=32):ONPNGOTO1300,1310,1320,1330
1200 ONTAGOTO1530,1340
1210 GOSUB1580
1220 GOTO1060
1230 EG=10:ZE=Z:NE=36+INT(Z/2):Z=24+INT(Z/2):YE=Y+16*(Z=24)-16*(Z=26):XE=X+16*(Z=27)-16*(Z=25):SE=1
1240 GOSUB1450:PUTSPRITE6,(XE,YE-1),8,NE:PUTSPRITE7,(XE,YE-1),EP,NE+4
1250 IFEG<15ANDG=0THENEG=1:SOUND8,0
1260 IFEG=1THENGOSUB1950:EG=-20:Z=ZE:SE=2:GOTO1060
1270 VV=VN+INT((8+XE)/16)+INT((YE+14)/16)*16:VA=VPEEK(VV):IFVA>140ANDVA<(145+EP*2)THENEG=1:VO=VA-135+6*(VA=141)+7*(VA=142):VM=32+16*(VA=141)+32*(VA=142):VY=INT((YE+14)/16)*16:VX=INT((XE+8)/16)*16:GOSUB1480
1280 FORI=0TO200:NEXTI:
1290 GOTO1190
1300 N=N+1:X=2:GOTO 1050
1310 N=N-1:X=238:GOTO 1050
1320 N=N+8:Y=32:GOTO 1050
1330 N=N-8:Y=192:GOTO 1050
1340 MA=0:TA=0:MB=0:VV=VN+INT((8+X)/16)+INT((Y+14)/16)*16:VY=INT((Y+14)/16)*16:VX=INT((X+8)/16)*16:VM=((VA+1)MOD2)*16:VO=0
1350 IFVC>31ANDVC<35ANDVD>31ANDVD<35THENLE=10:MB=3:GOSUB1470:GOTO1460
1360 IFVA<>VBTHEN1060
1370 'IFVA<39THENN=N+21:Y=176:GOTO1050
1380 'IFVA=39THENN=N-21:Y=50:GOTO1050
1390 IFVA<42THENLJ=LI:LJ=LJ+10::GOSUB1480:GOSUB1510:GOTO1060
1400 IFVA<48THENGL=GL+INT((VA-38)/2):GOSUB1480:GOSUB1490:GOTO1060
1410 IFVA<56THENI=INT((VA-48)/2):C(I)=C(I)+1:C(I)=-C(I)*(C(I)<10)-9*(C(I)>9):GOSUB1500:GOSUB1480:GOTO1060
1420 IFVA<58THENLM=LM+20:GOSUB1480:GOSUB1520:GOTO1060
1430 IFVA<61THENEP=VA-57:VM=16:GOSUB1480:COPY(147+EP*16,162)-(157+EP*16,174),2TO(132,1),0:GOTO1060
1440 BO=VA-60:VM=16:GOSUB1480:COPY(194+BO*16,162)-(205+BO*16,174),2TO(143,1),0:GOTO1060
1450 IFT(0)>8ORT(1)>8THENZ=ZZ+4
1455 PUTSPRITE0,(X,Y-1),9,Z:PUTSPRITE1,(X,Y-1),2,Z+6:PUTSPRITE2,(X,Y-1),1,Z+12:RETURN
1460 FORI=0TO15:Z=(IMOD8):GOSUB1450:ZT=1:GOSUB2000:FORJ=0TO600:NEXTJ:NEXTI:SOUND8,0:GOTO1040
1470 LJ=LI:LJ=LJ-LE:LJ=-LJ*(LJ>0):FORI=LITOLJSTEP-1:COPY(60,75)-(60,77),3TO(2+I,16),0:NEXTI:LI=LJ:RETURN
1480 VPOKEVV,VM+VO:COPY(VO*16,VM)-(15+VO*16,15+VM),2TO(VX,VY),0:G(0)=INT(GL/100):GOSUB1970:RETURN
1490 G(0)=INT(GL/100):G(1)=INT((GL-(G(0)*100))/10):G(2)=GL-G(1)*10-G(0)*100:FORI=0TO2:COPY(12+G(I)*6,201)-(17+G(I)*6,207),2TO(14+I*7,4),0:NEXTI:RETURN
1500 COPY(12+C(I)*6,201)-(17+C(I)*6,207),2TO(51+I*23,4),0:RETURN
1510 LJ=-LJ*(LJ=<LM)-LM*(LJ>LM):FORI=LITOLJ:COPY(2,76)-(2,76),3TO(I+2,17),0:MA=I:MB=1:NEXTI:LI=LJ:RETURN
1520 LM=-LM*(LM=<252)-252*(LM>252):COPY(1,17)-(1,17),3TO(3+LM,17),0:LJ=LM:GOSUB1510:RETURN
1530 MB=1:TA=0:VV=VN+INT((8+X)/16)+INT((TY+14)/16)*16:VY=INT((TY+14)/16)*16:VX=INT((X+8)/16)*16
1540 IFVT<160THENCT=(VT+2)MOD3:IFC(CT)>0THENTT=INT((VT-148)/3):I=CT:C(I)=C(I)-1:GOSUB1500:ONTTGOTO1880,1890,1900ELSEMB=2:GOSUB1970:GOTO1060
1550 IFVT<163THEN1910
1560 VM=112:VO=15:VA=(VT*2)-284:GOTO1400
1570 GOTO1060
1580 IFNS=0THEN1760
1590 SS=SS+1:IFSS=10THENSWAPR,RR:SS=0
1600 ONHGOTO1610,1650,1690
1610 IFGS=0THENXN=XN+DSELSEYN=YN+SD
1620 IFXN=XTHENGS=1:SD=1*(SY>Y)-1*(SY<Y)
1630 IFYN=YTHENGS=0:DS=1*(SX>X)-1*(SX<X)
1640 VS=VPEEK(VN+INT((8+XN)/16)+INT((YN+14)/16)*16):IFVS>37THENDS=-DS:SD=-SD:XN=SX:YN=SYELSESX=XN:SY=YN:GOTO1660
1650 SX=SX+DS:SY=SY+SD
1660 IFSX<1ORSX>239THENDS=-DS
1670 IFSY<33ORSY>191THENSD=-SD
1680 GOTO1730
1690 SX=SX+DS:SY=SY+SD
1700 IFSX<1ORSX>239THENDS=-DS:SD=1*(SY>Y)-1*(SY=<Y):IFDSMOD2=1THENDS=DS*2
1710 IFSY<31ORSY>191THENSD=-SD:DS=1*(SX>X)-1*(SX<X):IFSDMOD2=1THENSD=SD*2
1720 IFSY=YTHENSD=0:DS=1*(SX>X)-1*(SX<X)
1730 FORI=0TO40:NEXTI
1740 PUTSPRITE3,(SX,SY),40,SN+R:PUTSPRITE4,(SX,SY),38,SN+2+R:PUTSPRITE5,(SX,SY),SC,SN+4+R
1750 RETURN
1760 FORI=0TO88:NEXTI:SF=SF+1*(SF>-1):IFSF=0THEN1860ELSERETURN
1770 SPRITEOFF:RETURN:IFEG=0THEN1780ELSEIFSY>Y-15-8*(NE=48)ANDSY<Y+15+8*(NE=50)ANDSX>X-15-8*(NE=51)ANDSX<X+15+8*(NE=49)THEN1780ELSE1790
1780 ZS=20:LE=(SC*3)-BO:GOTO1470
1790 SF=SF-EP:EG=-20:Z=ZE:SE=2:GOSUB1950:IFSF<1THENNS=0:SF=60:GOSUB1940
1800 RETURN
1810 SOUND9,0:SOUND10,0:SOUND8,15:FORJ=0TO20:RESTORE1830:SOUND0,J*10:FORI=0TO10:SOUND1,I:READA:COPY(A,201)-(A+5,208),2TO(J*9+I*6,38+J*8):NEXTI:NEXTJ:SOUND8,0
1815 FORI=0TO7:PUTSPRITEI,(0,212),,0:NEXTI
1820 IFSTRIG(0)=-1THEN2080ELSE1820
1830 DATA0,114,78,150,102,0,162,204,102,180,0
1840 SPRITEOFF:VN=&H82E0+N*256:FORI=0TO8:PUTSPRITEI,(0,211),,63:NEXTI
1845 S(0)=60:S(1)=60
1850 FORI=0TO15:FORJ=2TO12:VA=VPEEK(VN+I+J*16):VY=(INT(VA/16))*16:VX=(VAMOD16)*16:COPY(VX,VY)-(15+VX,15+VY),2TO(I*16,J*16),0:NEXTJ:NEXTI
1860 SX=VPEEK(VN+211):SX=SX*16:SY=VPEEK(VN+212):SY=SY*16:NS=VPEEK(VN+210):SN=INT((NS-1)/3):SC=1+(NS-1)MOD3:SF=SC:H=SN+1:DS=1-1*(H=2):SD=DS:SN=SN*6+44:XN=SX:YN=SY
1870 RETURN
1880 VM=160:VO=VPEEK(VN+213)-160:GOSUB1480:GOTO1920
1890 VM=16:VO=13:GOSUB1480:GOTO1920
1900 VM=32:VO=5:GOSUB1480:GOTO1920
1910 FORI=0TO35:T=VPEEK(VN+218+I):COPY(T,201)-(5+T,208),2TO(3+I*7,200),3:COPY(3,200)-(3+I*7,207),3TO(250-I*7,22),0:MA=T:MB=0:GOSUB1980:NEXTI
1920 SOUND8,0:S=STICK(0):IFS>2ANDS<8THEN1930ELSEGOSUB2020:FORI=0TO470:NEXTI:GOTO1920
1930 NY=NY+2:TA=0:FORI=0TO34:COPY(0,151)-(6,158),3TO(3+I*7,22),0:COPY(O,151)-(6,158),3TO(2+I*7,200),3:NEXTI:GOTO1120
1940 PUTSPRITE3,(0,211),,63:PUTSPRITE4,(0,211),,63:PUTSPRITE5,(0,211),,63
1950 PUTSPRITE6,(0,211),,63:PUTSPRITE7,(0,211),,63
1960 RETURN
1970 SOUND1,MB:FORL=250TO0STEP-2:SOUND0,L:GOSUB1990:NEXTL:SOUND8,0:RETURN
1980 SOUND0,MA:SOUND1,MB
1990 FORK=9TO15:SOUND8,K:NEXTK:RETURN
2000 SOUND1,MB:FORL=250TO0STEP-2:SOUND0,L:SOUND8,15:NEXTL:SOUND8,0:RETURN
2010 SOUND0,MA:SOUND1,MB:SOUND8,12:RETURN
2020 FORI=0TO1:IFD(I)=0THEN2030ELSE2060
2030 SOUND9+I,0:IFI=1THEN2040ELSESOUND12,40:SOUND11,8:SOUND13,8
2040 A(I)=VPEEK(&H8000+J(I)+(I*384)):B(I)=VPEEK(&H8080+J(I)+(I*384)):D(I)=VPEEK(&H8100+J(I)+(I*384)):SOUND2+(I*2),A(I):SOUND3+(I*2),B(I):SOUND9+I,11-I*2:J(I)=J(I)+1
2045 'A(I)=VPEEK(&H8000+J(I)+(I*384)):B(I)=VPEEK(&H8080+J(I)+(I*384)):D(I)=VPEEK(&H8100+J(I)+(I*384)):SOUND2+(I*2),A(I):SOUND3+(I*2),B(I):SOUND9+I,16-(I*3):J(I)=J(I)+1
2050 IFD(I)=0THENJ(I)=0:GOTO2030
2060 D(I)=D(I)-4
2070 NEXTI:RETURN
2080 CALL TURBO OFF
2090 A=1:CLS:GOTO30
