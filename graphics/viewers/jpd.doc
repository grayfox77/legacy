▼▽▼▽▼▽▼▽▼▽▼▽▼▽▼▽▼▽▼▽▼▽▼▽▼▽▼▽▼▽▼▽▼▽▼▽▼▽▼

  JPEG-file decoder						JPD.COM

	ＪＰＤ ver0.42

		動作機種：MSX2+/turboR
				VDP : V9958

		動作環境：MSX-DOS2
				MMS(Memory-Mapper) : 2seg(Primary) or over

	copyright (c)1995-1996	Hiroyuki_KAKAMI		各務 裕之
	special-thanks		SEIGA			青河

▲△▲△▲△▲△▲△▲△▲△▲△▲△▲△▲△▲△▲△▲△▲△▲△▲△▲△▲△▲



■【概要】

　MSX-DOS2 の外部コマンドとして動作する、ＪＰＥＧ画像デコーダです。
　表示方法には、以下の３つが選択できます。

	・ＹＪＫモード (256x424:19268)，マトリクスディザ (2x4)
	・ＲＧＢモード (256x424:  256)，マトリクスディザ (4x8)
	・セピアモード (512x424:   16)，マトリクスディザ (4x4)

　以下のＪＰＥＧフォーマットのみに対応しています。

	・JFIF-format で、以下を充たすもの
		・Baseline-DCT（基本方式ＤＣＴ符号化）
		・Non-Hierarchical（非階層型）
		・Interleave（インターリーヴ方式）
		・ＹＵＶ色空間
		・色差間引きが (1:1:1), (2:1:1), (4:1:1) の何れか
		・画像の横ピクセル数が 1024 以下／2048 以下


　以下の説明のうち、次のような文字はそれぞれ次の意味を表します。
	< ･･ >	：　省略不可能
	[ ･･ ]	：　省略可能




■【使用方法】

　JPD は MSX-DOS2 上で使用します。usage は次のようになります。

	:> JPD.COM  <ファイル[.JPG]>  [オプション]



《ファイル》
　JPEGファイルを、Drive-Path-File で指定します。
　拡張子が省略された場合は、".JPG" となります。

　ワイルドカードの指定も可能です。その場合、キー入力によって設定を変えた
場合も、次のファイルでは強制的にオプションによる設定に戻されます。
　ただし、表示方法（ＹＪＫ／ＲＧＢ／セピア，モザイク）だけは継続されます。



《オプション》
　オプションは大文字でも小文字でも構いません。
　１つのオプションの前には、必ず１つの "/" を付けてください。


  /H	: help
		ヘルプを標準出力に表示します。

  /I	: info
		ファイル情報を表示します。

  /D<s> : save-dir
		BSAVE 機能によって保存されるディレクトリを指定します。
		省略時はカレントディレクトリになります。
		ルートでない限り、末尾の "\" は省略出来ます。
		ドライブ指定の ":" は省略出来ません。

  /S[n]	: screen
		表示方法を選択します。6〜8 はモザイク表示となります。
			0   : ＹＪＫ→ＲＧＢ→セピア 循環
			1,6 : ＹＪＫ (default)
			2,7 : ＲＧＢ
			3,8 : セピア

  /A	: auto							(default)
		画像の横サイズに合わせて、自動的に表示型式を変更します。
			・256		: [M]+[K]	: middle x2
			・512		: [M]		: middle
			・〜640		: [W]		: wide
			・641〜1024	: [F]		: full

  /M	: middle
		画像の横サイズ = 512 と見なします。

  /W	: wide
		横に 4/5 に縮小して表示します。
		画像の横サイズ = 640 と見なします。

  /F	: full
		横一杯に詰めて表示します。

  /C	: compress
		縦方向を 80 ％に圧縮します。ピクセル比の補正に使います。

  /X	: extend
		縦方向を 125 ％に伸長します。ピクセル比の補正に使います。

  /N	: monochrome	（隠し）
		全ての画面モードで、強制的にモノクロ表示します。
		都合上、ＲＧＢモードでは緑色で表示されます。

  /T[n]	: prohobit auto-correction	（隠し）
		n=1 で、横1024〜2048ピクセルの画像でも、補正を抑制します。
		n=0（default）で、自動補正を行います。
		n を省略すると、トグルスイッチとなります。

  /G	: Go-forcefully	（隠し）
		エラーの発生を無視し、実行を続けます。
		その後の動作保証は致しません。
		場合によっては、暴走する危険性もあります。


《キー操作》	（画像表示中）
　画像表示中はキー反応が若干鈍い為、比較的長く押し続けて下さい。

  [SPC]	 [trgA]		次のファイルへ移ります。

  [ESC]	 [trgB]		動作を終了して、DOS へ戻ります。

  [RET]			表示を中断します。


《キー操作》	（画像表示終了後）

  [SPC]	 [trgA]		次のファイルへ移ります。

  [ESC]	 [trgB]		動作を終了して、DOS へ戻ります。

  [@]			設定を変更せずに再表示します。

  [S]+[0]		表示方法をＹＪＫ→ＲＧＢ→セピアの順に循環します。
  [S]+[1] [F1]		表示方法をＹＪＫモードに変更します。
  [S]+[2] [F2]		表示方法をＲＧＢモードに変更します。
  [S]+[3] [F3]		表示方法をセピアモードに変更します。
  [S]+[6] [F6]		表示方法をＹＪＫモード（モザイク）に変更します。
  [S]+[7] [F7]		表示方法をＲＧＢモード（モザイク）に変更します。
  [S]+[8] [F8]		表示方法をセピアモード（モザイク）に変更します。

  [M] [W] [F] [A]	表示型式を変更します。

  [C] [X]		縦に圧縮・伸長します。
			表示型式の変更を行っても、解除されません。

  [K] [J]		拡大／縮小表示します。
			表示型式の変更（[M],[W],[F],[A]）で解除されます。

  [L] [R]		表示位置を、横に1/4画面だけ移動します。
			原画像が画面から横にはみ出た場合のみ有効です。

  [;] [:]		表示位置を、横に原画像の１ピクセル分だけ移動します。

  [T]			横2048ピクセルを越える画像の場合、自動補正を行います。
  [ctrl]+[T]		横2048ピクセルを越えても、補正を行いません。

  [↑] [↓]		縦方向に任意スクロールします。
			424ラインを越える画像のみ有効です。
			画像のサイズに応じた空きＭＭＳが必要です。
			容量が足りない場合、途中までしか正常に表示されません。

  [shift]+[↑] [↓]	１画面分だけスクロールします。

  [ctrl]+[O]		画像上端までスクロールします。
  [ctrl]+[P]		画像下端までスクロールします。

  [ctrl]+[G]		表示中の画面を BSAVE 型式でセーブします。
			オプション "/D<s>" で指定したディレクトリに書込みます。
			エラーの際は２回 beep が鳴ります。
			表示方法に対する拡張子は以下の通りです。
				・ＹＪＫモード	: ".SCC" & ".S1C"
				・ＲＧＢモード	: ".SC8" & ".S18"
				・セピアモード	: ".SC7" & ".S17"
			セピアモードの場合でも、パレット情報は保存されません。


《環境変数》

　JPDOPT	ディフォルトオプションを記述することが出来ます。
		解除出来ないオプション（"/I","/N","/G"）は避けて下さい。




■【エラー】

・Not MSX-DOS2.
　　DOS1や他のCP/M等で起動したときに表示されます。

・Bad option.
　　存在しないオプションを指定したときに表示されます。

・Too many Parameters.
　　パラメータの数が多すぎます。

・Bad Environment-option.
　　環境変数 "JPDOPT" に書かれた内容が不正です。

・Not enough TPA.
　　ＴＰＡサイズが不足しています。

・Not enough Memory-mapper segments.
　　メモリマッパー（プライマリ）のフリーセグメント数が不足しています。




■【諸注意】

　ＶＤＰの I/O ポートアドレスを n=n'=98h と固定している為、これ以外のＭ
ＳＸでは動作しません。（動作機種が MSX2+ 以上なので、問題無いと思います）

　ＭＭＳは最低でも、プライマリに２セグメント以上必要です。不足する場合は
実行出来ません。
　任意スクロールの際は、更に領域に応じたセグメント（こちらは外部ＭＭＳに
も対応）が必要です。不足する場合は画面表示が正常に行われません。

　表示中に効くキーは、[SPC] [ESC] [RET] [trgA] [trgB] だけです。
　[RET] さえ押せば全てのキーが有効になります。

　原画像の横ピクセル数が 1024 を越える場合には、プログラムの都合上、自動
的に横の解像度が半分になります。
　[ctrl]+[T] によって元の解像度に戻りますが、画像左端の表示が正常に行わ
れなくなります。（バグではなく仕様です）

　セピアモードでは、色差情報の逆量子化やＩＤＣＴなどが省ける為、画像に依っ
ては表示時間が半分程度まで短縮されることもあります。color-sampling が 1x1 
の場合に顕著です。
　モザイク表示の場合は、全てのＩＤＣＴを省略している為に幾らか高速に表示
します。

　セピアモードでのパレットの値は、以下の通りです。（RGB順）
	 0: 0,0,0	 1: 1,1,0	 2: 1,1,1	 3: 2,2,0
	 4: 2,2,1	 5: 3,3,0	 6: 3,3,1	 7: 4,4,0
	 8: 4,4,1	 9: 5,4,0	10: 5,4,1	11: 6,5,0
	12: 6,5,1	13: 7,6,1	14: 7,6,2	15: 7,6,4




■【参考】

・青河氏作
		ＪＰＥＧローダ "JLD.COM ver1.11" ソースファイル


・オーム社出版局
		わかりやすい ＪＰＥＧ／ＭＰＥＧ２の実現法	（￥２８００）
						   小野 定康・鈴木 純司  共著

・ＡＳＣＩＩ出版局
		最新ＭＰＥＧ教科書				（￥２９００）
								藤原 洋  監修

・ソフトバンク
		Ｏｈ！Ｘ 1995-10 特集「Now Printing」
			減色処理と印刷いろいろ			      瀧 康史




■【使用および配布について】

　このソフトウェアは Free-ware です。著作権は作者が保持しています。営利
・非営利を問わず、誰でも無料で使用することができます。

　転載・配布は自由です。確認及び連絡なども、特に必要としません。
　各自に於いて改良・改造したものは、その旨（原作者名，改造者名，改造箇所）
を明記した上で、配布は自由とします。

　このソフトウェアを使用した結果の影響については一切の責任を負いかねます
ので、あらかじめご了承ください。




■【謝辞】

　このプログラム中、高速ＩＤＣＴの演算に、青河氏作のＭＳＸ版ＪＰＥＧロー
ダ "JLD.COM" のアセンブリ・ソースファイルの一部を利用しています。
　更に "JLD.COM" は、戦うクラリス氏作の "JPGVQ0" のＣ言語ソースを参考に
している為、"JPD" も上プログラムの一部を利用していることになります。

　この場をもって、両氏に深く御礼申し上げます。




■【奥付】

　これまでの粗筋。
　青河氏に "JLD.COM" のソースを送って頂けたので、乗算部を R800 専用命令
で置き換え７〜８割まで時間短縮出来たが、μＫＫが「X68000XVI-24MHz なら以
下略」と言うので資料を買ってきて最初から組み直した所、スピードはそんなに
変わらなかった。ｶﾞｰﾝ


　BSAVE 機能は、青河氏の JLD とは違い、
	・ファイル名は、重複しない適当な名前に決められる
	・拡張子は "SC0" & "SC1" ではなく、"SC?" & "S1?" になる
	・画像と同じディレクトリではなく、"/D" で指定されるディレクトリ
	　（省略時はカレント）に保存される
	・保存後に強制終了しない
等の相違があります。
　ファイル名固定だと１画像につき１枚しか保存出来なくなる為、この様な仕様
になっています。スクロール位置を変えて何枚も保存したい場合に便利です。気
に入らなければ、JPD 終了後に各自でリネームして下さい。

　因にファイル名の意味は、以下の通り。
	"JP??????.S??"
	   ||||||  |+-- : screen-mode		{C,8,7}
	   ||||||  +--- : interlace-mode	{C,1}
	   |||+++------ : scroll-pointer	{$000〜$FFF}
	   ||+--------- : ID.inner		{$0〜$F}
	   ++---------- : ID.source-file	{$00〜$FF}


　拡大表示 [K] を正式対応した影響で、オプション "/L","/R" は廃止になり、
キー操作 [L],[R] の仕様も左右に1/4画面だけ表示窓を移動して再表示するよう
に変更されました。特に拡大表示の際に便利だと思います。


　環境変数 "JPDOPT" によりディフォルトオプションが記述出来るようになりま
した。勿論、実行時に通常のオプションを記入すれば、そちらが優先されます。
　主に、表示方式を指定するのに有用でしょう。「ディフォがＲＧＢぢゃなきゃ」
って人は、"set JPDOPT=/S2" として下さい。

　間違って "/I" や "/N" なんかを記述してしまうと、解除できないので注意。
あと、"/G" なんかも止めた方が良いかと。


　今までのバージョンでは、横1024ピクセルを越える画像を表示すると画像左端
にゴミが出てしまいました。これは、IUV の保存にＭＭＳを 2seg (32KB) しか
使っていないことに起因するものです。
　ＪＰＤを開発していた当初は、「横ピクセルが 1024 を越えるファイルなんて
滅多に無いだろう」と高を括っていたんだけれど、意外とあるようで。都築和彦
の画集にも、横2048ピクセルの画像がいくつか入っているらしいし。

　仕方が無いので、画質を落とす代わりに横2048ピクセルまで正常に表示できる
ようにしてみました。拡大表示した場合に粗が気になるのなら、[ctrl]+[T] で
元の解像度になります。その代わり画像左端にやっぱりゴミが出ます。

　実は当初は、別ファイルとして「JPDW.COM」というのを作って、巨大画像の場
合にユーザ側で使い分けてもらう目論見で。ドキュメントやら転載用ヘッダやら
も全部書いたんだけど、結局ＪＰＤに組み込んでしまいました。
　結局、単なる自己書換えの山で対応したまで。


　で、ネットに上げる前に１日でバージョンアップ。取りあえず前々から付けよ
うかと思っていて延ばし延ばしになっていた機能を追加しました。
　それにしても、ソースファイルを１モジュールで組んでいるから、AKID でも 
Out of Memory が連発して困ってしまう。分割コンパイルは性に合わないし。


				〒500 岐阜市宇佐南１-２-５
							各務 裕之 （ＡＰｉ）

	東京	Natsume-Net				NAT26323
	東京	MARIO-NET				API
	岐阜	あしながねっと				API
	大阪	Illusion City				API
	愛知	PrincessPrincess-NET			API
	石川	ネットフレンティ金沢			NWC03867

	E-mail	:     kakami@toriwaki.nuie.nagoya-u.ac.jp
	URL	: http://www.toriwaki.nuie.nagoya-u.ac.jp/~kakami/


[eof]
